steps:
  # Paso 1: Construir la imagen de Docker (sin las credenciales)
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/todo-api', '.']

  # Paso 2: Subir la imagen a Artifact Registry
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/todo-api']

  # Paso 3: Desplegar la imagen en Cloud Run, pasando las credenciales como variables de entorno
- name: 'gcr.io/google.com/cloudsdk/cloud-sdk'
  args:
    - gcloud
    - run
    - deploy
    - todo-api-service
    - --image
    - gcr.io/$PROJECT_ID/todo-api
    - --region
    - us-central1
    - --allow-unauthenticated
    - --platform
    - managed
    - --set-env-vars
    - DB_USER=$DB_USER_SECRET,DB_PASSWORD=$DB_PASSWORD_SECRET,DB_NAME=$DB_NAME_SECRET

# Sustituciones y variables
substitutions:
  # Aquí debes poner las variables que no son sensibles, como el nombre de la BD
  _DB_NAME: "todo-db"

# Para las variables sensibles (usuario y contraseña), usa Secret Manager y suscríbete a ellas
availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/todo-user-secret/versions/latest
    env: DB_USER_SECRET
  - versionName: projects/$PROJECT_ID/secrets/todo-password-secret/versions/latest
    env: DB_PASSWORD_SECRET